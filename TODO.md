# Hyperliquid Super Signal - TODO List

This document lists identified issues, bugs, and improvements based on a comprehensive codebase scan.

## Critical Issues (Must Fix)

- [x] **Implement Strategy Exits in TradingEngine**
  - **Location**: `src/core/engine.ts`, `src/strategies/superSignal.ts`
  - **Issue**: The `TradingEngine` currently ignores exit signals generated by `SuperSignalStrategy.shouldExit` (e.g., Stoch crossing 80/20). It relies solely on initial Stop Loss and Take Profit orders.
  - **Action**: In `TradingEngine.handleCandle`, add logic to check for exit signals (using `SignalProcessor.checkExits` or similar) and execute `closePosition` when an exit condition is met.
  - **Status**: ✅ Completed - Added exit signal checking in `handleCandle` method. Now checks for strategy exit conditions before processing trailing stops and closes positions when exit signals are triggered.

- [x] **Implement Trailing Stop Order Updates**
  - **Location**: `src/core/engine.ts`
  - **Issue**: The `updateTrailingStop` method calculates the new trailing stop price and updates the local state, but the code to actually **cancel the existing Stop Loss order and place a new one** is missing (commented out/placeholder).
  - **Action**: Implement the `client.api.cancelOrders` and `client.api.placeOrder` calls within `updateTrailingStop` to finalize the trailing stop mechanism.
  - **Status**: ✅ Completed - Added `stopLossOrderId` tracking to Position interface, implemented order ID extraction in `evaluateEntry`, and full order cancellation/placement logic in `updateTrailingStop`.

## High Priority Features

- [x] **Integrate Order Book Analysis**
  - **Location**: `src/core/engine.ts`, `src/trading/order-book/`
  - **Issue**: `OrderBookAnalyzer` and `OrderBookManager` are fully implemented (providing slippage estimation and liquidity analysis) but are **unused** by the `TradingEngine`. The bot currently places orders without checking order book depth or potential slippage.
  - **Action**: 
    1. Inject `OrderBookManager` into `TradingEngine`.
    2. In `evaluateEntry`, use `orderBookAnalyzer.calculateExecutionParameters` to determine optimal order size and limit price.
    3. Use `estimateSlippage` to reject trades if slippage is too high.
  - **Status**: ✅ Completed - Injected `OrderBookManager` and `OrderBookAnalyzer` into `TradingEngine` constructor. Added slippage estimation in `evaluateEntry` that rejects trades with >0.5% slippage or insufficient liquidity.

## Improvements & Cleanup

- [ ] **Consolidate Trading Logic**
  - **Location**: `src/index.ts`, `src/core/engine.ts`
  - **Issue**: `HyperliquidSuperSignal` class initializes `OrderBookManager`, but `TradingEngine` (which handles the actual trading) doesn't use it.
  - **Action**: Move `OrderBookManager` usage into `TradingEngine` or ensure `HyperliquidSuperSignal` passes the necessary data to the engine.

- [x] **Verify Divergence Logic Continuation Check**
  - **Location**: `src/indicators/divergence.ts`
  - **Task**: The `detectBullish` and `detectBearish` methods check if `currentPrice` continues the divergence (e.g., `current < lastPivot`). Verify if this "continuation" check is strictly required or if standard pivot-to-pivot divergence is sufficient.
  - **Status**: ✅ Completed - Removed the overly restrictive continuation check. Per the strategy ("Buy any divergence that appears inside the channel"), standard pivot-to-pivot divergence detection is sufficient. The location/stochastic level conditions are handled by other parts of the strategy.

- [x] **Validate Hardcoded Trading Pairs**
  - **Location**: `src/types/index.ts`
  - **Task**: Verify that `HYPE-USDC` and `FARTCOIN-USDC` are valid symbol names on Hyperliquid relative to the API's expectations (e.g., casing, presence).
  - **Status**: ✅ Verified - All trading pairs (ETH, BTC, HYPE, SOL, FARTCOIN, BNB, DOGE) confirmed as valid perpetual symbols via `meta` API endpoint. The internal `XXX-USDC` format is correctly split to extract the coin name (e.g., `"BTC"`) before API calls.

## Testing

- [x] **Add Unit Tests for TradingEngine**
  - **Task**: Create tests for `TradingEngine` specifically covering:
    - Integration of `checkExits`.
    - Correct execution of `updateTrailingStop` (mocking the API calls).
    - Risk manager rejection logic.
  - **Status**: ✅ Completed - Created `tests/unit/engine.test.ts` with 13 unit tests:
    - Exit signal integration (3 tests): checkExits called, position closed, no entry after exit
    - Risk manager rejection (4 tests): canTrade rejection, zero size, zero balance, successful trade
    - Trailing stop updates (5 tests): no update when not profitable, activation at 1%, cancelOrders, placeOrder, order ID tracking
    - Position queries (1 test): getPositions returns all open positions
